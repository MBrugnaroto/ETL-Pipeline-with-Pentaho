USE `dwsucos`;
DROP procedure IF EXISTS `SP_MONTAESQDIR3`;

DELIMITER $$
USE `dwsucos`$$
CREATE DEFINER=`root`@`127.0.0.1` PROCEDURE `SP_MONTAESQDIR3`()
BEGIN
SET max_sp_recursion_depth=255;
SET @v_Id  = (SELECT ID FROM TEMP_AUXCONTROLE ORDER BY POS DESC LIMIT 1);
SET @v_Contador = (SELECT CONTADOR FROM TEMP_AUXCONTROLE ORDER BY POS DESC LIMIT 1);
SET @v_Nivel = (SELECT NIVEL FROM TEMP_AUXCONTROLE ORDER BY POS DESC LIMIT 1);
UPDATE TEMP_AUXTABELA SET ESQ = @v_Contador WHERE ID = @v_Id;
UPDATE TEMP_AUXTABELA SET NIVEL = @v_Nivel WHERE ID = @v_Id;
SET @v_Contador = @v_Contador + 1;
SET @v_Nivel = @v_Nivel + 1;
SET @v_Membros = (SELECT COUNT(*) FROM TEMP_AUXTABELA WHERE IDPAI = @v_Id AND ESQ = 0) ;
WHILE @v_Membros > 0 DO
	     SET @v_Id2 = (SELECT ID FROM TEMP_AUXTABELA WHERE IDPAI = @v_Id AND ESQ = 0 ORDER BY ID LIMIT 1);
		 INSERT INTO TEMP_AUXCONTROLE (ID, CONTADOR, NIVEL) VALUES (@v_ID2, @v_Contador, @v_Nivel);	 	
		 
         SET @v_IdAux4 = @v_Id;
         CALL SP_MONTAESQDIR4;
         SET @v_Id = @v_IdAux4;
		
        SET @v_Contador = (SELECT CONTADOR FROM TEMP_AUXCONTROLE ORDER BY POS DESC LIMIT 1);
		 SET @v_Membros = (SELECT COUNT(*) FROM TEMP_AUXTABELA WHERE IDPAI = @v_Id AND ESQ = 0);
		 SET @v_Contador = @v_Contador + 1;
END WHILE;
INSERT INTO TEMP_AUXCONTROLE (ID, CONTADOR, NIVEL) VALUES (@v_ID, @v_Contador, @v_Nivel);
UPDATE TEMP_AUXTABELA SET DIR = @v_Contador WHERE ID = @v_Id;
END$$

DELIMITER ;

